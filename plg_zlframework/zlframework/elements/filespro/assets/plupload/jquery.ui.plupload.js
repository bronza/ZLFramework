/**
 * jquery.ui.plupload.js
 *
 * Copyright 2009, Moxiecode Systems AB
 * Released under GPL License.
 *
 * License: http://www.plupload.com/license
 * Contributing: http://www.plupload.com/contributing
 *
 * Depends:
 *	jquery.ui.core.js
 *	jquery.ui.widget.js
 *	
 * Optionally:
 *	jquery.ui.button.js
 *	jquery.ui.progressbar.js
 *	jquery.ui.sortable.js
 */
(function(n,p,e,c){function f(a){return e.translate(a)||a}var m={};c.widget("ui.plupload",{contents_bak:"",runtime:null,options:{browse_button_hover:"ui-state-hover",browse_button_active:"ui-state-active",dragdrop:!0,multiple_queues:!0,buttons:{browse:!0,start:!0,stop:!0},autostart:!1,sortable:!1,rename:!1,max_file_count:0},FILE_COUNT_ERROR:-9001,_create:function(){var a=this,b,d;b=this.element.attr("id");b||(b=e.guid(),this.element.attr("id",b));this.id=b;this.contents_bak=this.element.html();this.element.html('<div class="plupload_wrapper"><div class="ui-widget-content plupload_container"><div class="plupload"><div class="ui-state-default ui-widget-header plupload_header"><div class="plupload_header_content"><div class="plupload_header_title">'+
f("Select files")+'</div><div class="plupload_header_text">'+f("Add files to the upload queue and click the start button.")+'</div></div></div><div class="plupload_content"><table class="plupload_filelist"><tr class="ui-widget-header plupload_filelist_header"><td class="plupload_cell plupload_file_name">'+f("Filename")+'</td><td class="plupload_cell plupload_file_status">'+f("Status")+'</td><td class="plupload_cell plupload_file_size">'+f("Size")+'</td><td class="plupload_cell plupload_file_action">&nbsp;</td></tr></table><div class="plupload_scroll"><table class="plupload_filelist_content"></table></div><table class="plupload_filelist"><tr class="ui-widget-header ui-widget-content plupload_filelist_footer"><td class="plupload_cell plupload_file_name"><div class="plupload_buttons"><\!-- Visible --\><a class="plupload_button plupload_add">'+
f("Add Files")+'</a>&nbsp;<a class="plupload_button plupload_start">'+f("Start Upload")+'</a>&nbsp;<a class="plupload_button plupload_stop plupload_hidden">'+f("Stop Upload")+'</a>&nbsp;</div><div class="plupload_started plupload_hidden"><\!-- Hidden --\><div class="plupload_progress plupload_right"><div class="plupload_progress_container"></div></div><div class="plupload_cell plupload_upload_status"></div><div class="plupload_clearer">&nbsp;</div></div></td><td class="plupload_file_status"><span class="plupload_total_status">0%</span></td><td class="plupload_file_size"><span class="plupload_total_file_size">0 kb</span></td><td class="plupload_file_action"></td></tr></table></div></div></div><input class="plupload_count" value="0" type="hidden"></div>');
this.container=c(".plupload_container",this.element).attr("id",b+"_container");this.filelist=c(".plupload_filelist_content",this.container).attr({id:b+"_filelist",unselectable:"on"});this.browse_button=c(".plupload_add",this.container).attr("id",b+"_browse");this.start_button=c(".plupload_start",this.container).attr("id",b+"_start");this.stop_button=c(".plupload_stop",this.container).attr("id",b+"_stop");c.ui.button&&(this.browse_button.button({icons:{primary:"ui-icon-circle-plus"}}),this.start_button.button({icons:{primary:"ui-icon-circle-arrow-e"},
disabled:!0}),this.stop_button.button({icons:{primary:"ui-icon-circle-close"}}));this.progressbar=c(".plupload_progress_container",this.container);c.ui.progressbar&&this.progressbar.progressbar();this.counter=c(".plupload_count",this.element).attr({id:b+"_count",name:b+"_count"});d=this.uploader=m[b]=new e.Uploader(c.extend({container:b,browse_button:b+"_browse"},this.options));d.bind("Error",function(b,c){c.code===e.INIT_ERROR&&a.destroy()});d.bind("Init",function(b,i){a.options.buttons.browse||
(a.browse_button.button("disable").hide(),b.disableBrowse(!0));a.options.buttons.start||a.start_button.button("disable").hide();a.options.buttons.stop||a.stop_button.button("disable").hide();!a.options.unique_names&&a.options.rename&&a._enableRenaming();d.features.dragdrop&&a.options.dragdrop&&a._enableDragAndDrop();a.container.attr("title",f("Using runtime: ")+(a.runtime=i.runtime));a.start_button.click(function(b){c(this).button("option","disabled")||a.start();b.preventDefault()});a.stop_button.click(function(b){a.stop();
b.preventDefault()})});a.options.max_file_count&&d.bind("FilesAdded",function(b,c){var d=[],d=c.length,g=b.files.length+d-a.options.max_file_count;0<g&&(d=c.splice(d-g,g),b.trigger("Error",{code:a.FILE_COUNT_ERROR,message:f("File count error."),file:d}))});d.init();d.bind("FilesAdded",function(b,c){a._trigger("selected",null,{up:b,files:c});a.options.autostart&&setTimeout(function(){a.start()},10)});d.bind("FilesRemoved",function(b,c){a._trigger("removed",null,{up:b,files:c})});d.bind("QueueChanged",
function(){a._updateFileList()});d.bind("StateChanged",function(){a._handleState()});d.bind("UploadFile",function(b,c){a._handleFileStatus(c)});d.bind("FileUploaded",function(b,c){a._handleFileStatus(c);a._trigger("uploaded",null,{up:b,file:c})});d.bind("UploadProgress",function(b,d){c("#"+d.id).find(".plupload_file_status").html(d.percent+"%").end().find(".plupload_file_size").html(e.formatSize(d.size));a._handleFileStatus(d);a._updateTotalProgress();a._trigger("progress",null,{up:b,file:d})});d.bind("UploadComplete",
function(b,c){a._trigger("complete",null,{up:b,files:c})});d.bind("Error",function(b,c){var d=c.file,g,j;if(d){g="<strong>"+c.message+"</strong>";if(j=c.details)g+=" <br /><i>"+c.details+"</i>";else{switch(c.code){case e.FILE_EXTENSION_ERROR:j=f("File: %s").replace("%s",d.name);break;case e.FILE_SIZE_ERROR:j=f("File: %f, size: %s, max file size: %m").replace(/%([fsm])/g,function(b,c){switch(c){case "f":return d.name;case "s":return d.size;case "m":return e.parseSize(a.options.max_file_size)}});break;
case a.FILE_COUNT_ERROR:j=f("Upload element accepts only %d file(s) at a time. Extra files were stripped.").replace("%d",a.options.max_file_count);break;case e.IMAGE_FORMAT_ERROR:j=e.translate("Image format either wrong or not supported.");break;case e.IMAGE_MEMORY_ERROR:j=e.translate("Runtime ran out of available memory.");break;case e.IMAGE_DIMENSIONS_ERROR:j=e.translate("Resoultion out of boundaries! <b>%s</b> runtime supports images only up to %wx%hpx.").replace(/%([swh])/g,function(a,c){switch(c){case "s":return b.runtime;
case "w":return b.features.maxWidth;case "h":return b.features.maxHeight}});break;case e.HTTP_ERROR:j=f("Upload URL might be wrong or doesn't exist")}g+=" <br /><i>"+j+"</i>"}a.notify("error",g);a._trigger("error",null,{up:b,file:d,error:g})}})},_setOption:function(a,b){"buttons"==a&&"object"==typeof b&&(b=c.extend(this.options.buttons,b),b.browse?(this.browse_button.button("enable").show(),up.disableBrowse(!1)):(this.browse_button.button("disable").hide(),up.disableBrowse(!0)),b.start?this.start_button.button("enable").show():
this.start_button.button("disable").hide(),b.stop?this.start_button.button("enable").show():this.stop_button.button("disable").hide());this.uploader.settings[a]=b},start:function(){this.uploader.start();this._trigger("start",null)},stop:function(){this.uploader.stop();this._trigger("stop",null)},getFile:function(a){return"number"===typeof a?this.uploader.files[a]:this.uploader.getFile(a)},removeFile:function(a){(a=this.getFile(a))&&this.uploader.removeFile(a)},clearQueue:function(){this.uploader.splice()},
getUploader:function(){return this.uploader},refresh:function(){this.uploader.refresh()},_handleState:function(){var a=this.uploader;a.state===e.STARTED?(c(this.start_button).button("disable"),c([]).add(this.stop_button).add(".plupload_started").removeClass("plupload_hidden"),c(".plupload_upload_status",this.element).text(f("Uploaded %d/%d files").replace("%d/%d",a.total.uploaded+"/"+a.files.length)),c(".plupload_header_content",this.element).addClass("plupload_header_content_bw")):(c([]).add(this.stop_button).add(".plupload_started").addClass("plupload_hidden"),
this.options.multiple_queues&&(c(this.start_button).button("enable"),c(".plupload_header_content",this.element).removeClass("plupload_header_content_bw")),this._updateFileList())},_handleFileStatus:function(a){var b,d;if(c("#"+a.id).length){switch(a.status){case e.DONE:b="plupload_done";d="ui-icon ui-icon-circle-check";break;case e.FAILED:b="ui-state-error plupload_failed";d="ui-icon ui-icon-alert";break;case e.QUEUED:b="plupload_delete";d="ui-icon ui-icon-circle-minus";break;case e.UPLOADING:b="ui-state-highlight plupload_uploading";
d="ui-icon ui-icon-circle-arrow-w";var f=c(".plupload_scroll",this.container),i=f.scrollTop(),k=f.height(),g=c("#"+a.id).position().top+c("#"+a.id).height();k<g&&f.scrollTop(i+g-k)}c("#"+a.id).attr("class",b+" ui-state-default plupload_file").find(".ui-icon").attr("class",d)}},_updateTotalProgress:function(){var a=this.uploader;this.progressbar.progressbar("value",a.total.percent);this.element.find(".plupload_total_status").html(a.total.percent+"%").end().find(".plupload_total_file_size").html(e.formatSize(a.total.size)).end().find(".plupload_upload_status").text(f("Uploaded %d/%d files").replace("%d/%d",
a.total.uploaded+"/"+a.files.length))},_updateFileList:function(){var a=this,b=this.uploader,d=this.filelist,l=0,i,k=this.id+"_",g;c.ui.sortable&&this.options.sortable&&c("tbody.ui-sortable",d).sortable("destroy");d.empty();c.each(b.files,function(f,h){g="";i=k+l;h.status===e.DONE&&(h.target_name&&(g+='<input type="hidden" name="'+i+'_tmpname" value="'+e.xmlEncode(h.target_name)+'" />'),g+='<input type="hidden" name="'+i+'_name" value="'+e.xmlEncode(h.name)+'" />',g+='<input type="hidden" name="'+
i+'_status" value="'+(h.status===e.DONE?"done":"failed")+'" />',l++,a.counter.val(l));d.append('<tr class="ui-state-default plupload_file" id="'+h.id+'"><td class="plupload_cell plupload_file_name"><span>'+h.name+'</span></td><td class="plupload_cell plupload_file_status">'+h.percent+'%</td><td class="plupload_cell plupload_file_size">'+e.formatSize(h.size)+'</td><td class="plupload_cell plupload_file_action"><div class="ui-icon"></div>'+g+"</td></tr>");a._handleFileStatus(h);c("#"+h.id+".plupload_delete .ui-icon, #"+
h.id+".plupload_done .ui-icon").click(function(a){c("#"+h.id).remove();b.removeFile(h);a.preventDefault()});a._trigger("updatelist",null,d)});0===b.total.queued?c(".ui-button-text",a.browse_button).text(f("Add Files")):c(".ui-button-text",a.browse_button).text(f("%d files queued").replace("%d",b.total.queued));b.files.length===b.total.uploaded+b.total.failed?a.start_button.button("disable"):a.start_button.button("enable");d[0].scrollTop=d[0].scrollHeight;a._updateTotalProgress();!b.files.length&&
b.features.dragdrop&&b.settings.dragdrop?c("#"+i+"_filelist").append('<tr><td class="plupload_droptext">'+f("Drag files here.")+"</td></tr>"):a.options.sortable&&c.ui.sortable&&a._enableSortingList()},_enableRenaming:function(){var a=this;c(".plupload_delete .plupload_file_name span",this.filelist).live("click",function(b){var d=c(b.target),e,f,k="";e=a.uploader.getFile(d.parents("tr")[0].id);f=e.name;if(b=/^(.+)(\.[^.]+)$/.exec(f))f=b[1],k=b[2];d.hide().after('<input class="plupload_file_rename" type="text" />');
d.next().val(f).focus().blur(function(){d.show().next().remove()}).keydown(function(a){var b=c(this);-1!==c.inArray(a.keyCode,[13,27])&&(a.preventDefault(),13===a.keyCode&&(e.name=b.val()+k,d.text(e.name)),b.blur())})})},_enableDragAndDrop:function(){this.filelist.append('<tr><td class="plupload_droptext">'+f("Drag files here.")+"</td></tr>");this.filelist.parent().attr("id",this.id+"_dropbox");this.uploader.settings.drop_element=this.options.drop_element=this.id+"_dropbox"},_enableSortingList:function(){var a=
this;2>c("tbody tr",this.filelist).length||c("tbody",this.filelist).sortable({containment:"parent",items:".plupload_delete",helper:function(a,c){return c.clone(!0).find("td:not(.plupload_file_name)").remove().end().css("width","100%")},stop:function(){var b=[];c.each(c(this).sortable("toArray"),function(c,e){b[b.length]=a.uploader.getFile(e)});b.unshift(b.length);b.unshift(0);Array.prototype.splice.apply(a.uploader.files,b)}})},notify:function(a,b){var d=c('<div class="plupload_message"><span class="plupload_message_close ui-icon ui-icon-circle-close" title="'+
f("Close")+'"></span><p><span class="ui-icon"></span>'+b+"</p></div>");d.addClass("ui-state-"+("error"===a?"error":"highlight")).find("p .ui-icon").addClass("ui-icon-"+("error"===a?"alert":"info")).end().find(".plupload_message_close").click(function(){d.remove()}).end();c(".plupload_header_content",this.container).append(d)},destroy:function(){c(".plupload_button",this.element).unbind();c.ui.button&&c(".plupload_add, .plupload_start, .plupload_stop",this.container).button("destroy");c.ui.progressbar&&
this.progressbar.progressbar("destroy");c.ui.sortable&&this.options.sortable&&c("tbody",this.filelist).sortable("destroy");this.uploader.destroy();this.element.empty().html(this.contents_bak);this.contents_bak="";c.Widget.prototype.destroy.apply(this)}})})(window,document,plupload,jQuery);